{% extends "sqladmin/layout.html" %}

{% block content %}
<div class="container-fluid p-4">
    <div class="row mb-4">
        <!-- Row 1: Key Metrics -->
        <div class="col-md-3">
            <div class="card p-3 shadow-sm border-0 bg-primary text-white">
                <div class="card-body">
                    <h6 class="text-uppercase opacity-75 small">Total Revenue/Cost</h6>
                    <div class="d-flex align-items-center justify-content-between">
                        <h2 class="mb-0" id="total-cost">$0.00</h2>
                        <i class="fa-solid fa-sack-dollar fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 shadow-sm border-0 bg-success text-white">
                <div class="card-body">
                    <h6 class="text-uppercase opacity-75 small">Active Users (30d)</h6>
                    <div class="d-flex align-items-center justify-content-between">
                        <h2 class="mb-0" id="active-users">0</h2>
                        <i class="fa-solid fa-users fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 shadow-sm border-0 bg-info text-white">
                <div class="card-body">
                    <h6 class="text-uppercase opacity-75 small">Avg Latency</h6>
                    <div class="d-flex align-items-center justify-content-between">
                        <h2 class="mb-0" id="avg-latency">0ms</h2>
                        <i class="fa-solid fa-bolt fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 shadow-sm border-0 bg-warning text-white">
                <div class="card-body">
                    <h6 class="text-uppercase opacity-75 small">Job Conversion</h6>
                    <div class="d-flex align-items-center justify-content-between">
                        <h2 class="mb-0" id="conversion-rate">0%</h2>
                        <i class="fa-solid fa-filter fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- Main Line Chart -->
        <div class="col-md-8">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h5 class="card-title mb-0">Traffic & Cost (Last 14 Days)</h5>
                </div>
                <div class="card-body">
                    <canvas id="usageChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Doughnut Chart: Job Status -->
        <div class="col-md-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h5 class="card-title mb-0">Job Status Funnel</h5>
                </div>
                <div class="card-body d-flex justify-content-center">
                    <canvas id="statusChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3: Model Usage -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h5 class="card-title mb-0">AI Model Usage Breakdown</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Model Name</th>
                                    <th>Total Calls</th>
                                    <th>Total Cost (USD)</th>
                                    <th>Avg Cost per Call</th>
                                </tr>
                            </thead>
                            <tbody id="model-table-body">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    async function loadStats() {
        try {
            const response = await fetch('/api/v1/admin/stats');
            const data = await response.json();

            // 1. Update KPI Cards
            document.getElementById('total-cost').textContent = '$' + data.overview.total_cost_usd.toFixed(2);
            document.getElementById('active-users').textContent = data.overview.active_users_30d;
            document.getElementById('avg-latency').textContent = data.overview.avg_latency_ms + 'ms';
            document.getElementById('conversion-rate').textContent = data.overview.conversion_rate + '%';

            // 2. Line Chart: Usage History
            const daily = data.daily_stats.reverse();
            new Chart(document.getElementById('usageChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: daily.map(d => d.date),
                    datasets: [
                        {
                            label: 'Cost (USD)',
                            data: daily.map(d => d.total_cost),
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            yAxisID: 'y',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Requests',
                            data: daily.map(d => d.total_requests),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            yAxisID: 'y1',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { position: 'left', title: { display: true, text: 'Cost' }, beginAtZero: true },
                        y1: { position: 'right', title: { display: true, text: 'Reqs' }, grid: { drawOnChartArea: false }, beginAtZero: true }
                    }
                }
            });

            // 3. Doughnut Chart: Job Status
            const statuses = Object.keys(data.job_status_distribution);
            new Chart(document.getElementById('statusChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: statuses,
                    datasets: [{
                        data: Object.values(data.job_status_distribution),
                        backgroundColor: ['#e2e8f0', '#fbbf24', '#10b981', '#ef4444'], // Created, Parsed, Accepted, Failed/Etc
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // 4. Fill Model Table
            const setupTable = (models) => {
                const tbody = document.getElementById('model-table-body');
                tbody.innerHTML = '';
                models.forEach(m => {
                    const avg = m.calls > 0 ? (m.cost / m.calls).toFixed(5) : '0.00000';
                    const tr = `<tr>
                        <td class="fw-bold text-primary">${m.model}</td>
                        <td>${m.calls}</td>
                        <td>$${m.cost.toFixed(4)}</td>
                        <td class="text-muted">$${avg}</td>
                    </tr>`;
                    tbody.innerHTML += tr;
                });
            }
            setupTable(data.model_usage);

        } catch (e) {
            console.error("Failed to load admin stats", e);
        }
    }
    loadStats();
</script>
{% endblock %}